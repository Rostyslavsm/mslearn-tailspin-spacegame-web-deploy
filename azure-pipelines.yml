trigger:
- '*'

stages:

# -----------------------------------------------------------
# STAGE 1: "Build" on the Self-Hosted Agent
# -----------------------------------------------------------
- stage: 'Build'
  displayName: 'Build on Self-Hosted Agent'
  jobs: 
  - job: 'Build'
    displayName: 'Create and Package Artifact'
    pool:
      name: 'SecureAgents' # This targets your VM agent

    steps:
    # 1. Create a simple index.html file to act as our "build output".
    - script: echo "Pipeline run $(Build.BuildNumber) was deployed successfully." > $(Build.ArtifactStagingDirectory)/index.html
      displayName: 'Create Dummy Web Page'

    # 2. Zip the file. The Azure Web App deployment task expects a .zip file.
    - task: ArchiveFiles@2
      displayName: 'Archive files into a .zip package'
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/WebApp.zip'
        replaceExistingArchive: true

    # 3. Publish the .zip file as an artifact named 'drop' so other stages can use it.
    - publish: '$(Build.ArtifactStagingDirectory)/WebApp.zip'
      artifact: drop
      displayName: 'Publish Artifact'

# -----------------------------------------------------------
# STAGE 2: "Test" on the Self-Hosted Agent
# -----------------------------------------------------------
- stage: 'Test'
  displayName: 'Test on Self-Hosted Agent'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: 'TestJob'
    displayName: 'Run Simple Tests'
    pool:
      name: 'SecureAgents' # This also targets your VM agent
    
    steps:
    - script: echo "Simulating automated tests on the self-hosted agent..."
      displayName: 'Run Dummy Unit Tests'

# -----------------------------------------------------------
# STAGE 3: Deploy from a Microsoft-Hosted Agent
# This stage downloads the artifact and deploys it.
# -----------------------------------------------------------
- stage: 'Deploy'
  displayName: 'Deploy from Azure-Hosted Agent'
  dependsOn: Test
  condition: succeeded()
  jobs:
  - deployment: 'DeployToDev'
    displayName: 'Deploy to Dev Environment'
    pool:
      vmImage: 'ubuntu-22.04' # This targets a fast Microsoft agent
    
    environment: 'Development' # This enables manual approval

    strategy:
      runOnce:
        deploy:
          steps:
          # 1. Download the 'drop' artifact (our WebApp.zip file).
          - download: current
            artifact: drop
          
          # 2. Deploy the .zip to your Azure Web App.
          - task: AzureWebApp@1
            displayName: 'Azure App Service Deploy: Dev Website'
            inputs:
              # IMPORTANT: Make sure these values are correct for your setup!
              azureSubscription: 'Azure subscription 1(25ce748a-be5c-42fd-b2f6-d6a5d73d5a3d)'
              appType: 'webAppLinux'
              appName: 'tailspin-space-game-web-dev-22768' 
              package: '$(Pipeline.Workspace)/drop/WebApp.zip' # Path to our simplified .zip file